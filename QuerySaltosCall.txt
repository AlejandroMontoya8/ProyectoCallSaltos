select Orden,Shipment, Local,Tipo,Monto, Tipo_Pago, count (Linea) cantidad_SKU, sum (cantidad_unidades) cantidad_unidades, sum (total_compra) total_compra,despacho, email,
Nombre, Apellido, Telefono, ID, direccion,sector,ciudad,latitud,longitud,ASSIGNED_TO_USER_ID,estado,fecha_venta,Fecha_PDA,Fecha_inicio_picking, Fecha_Fin_Picking,fecha_intransit, fecha_entrega,fecha_vuelta, fecha_Fallido, fecha_Cancelacion,FULFILLMENT_TYPE,MODIFYUSERID,CREATEUSERID from (SELECT ol.EXTN_IS_PRES_HOLD_REQUIRED receta,OH.EXTN_IS_PRE_SALES_ENABLED PreV, OH.ORDER_NO Orden, case when OH.EXTN_ET_FULFILMENT='T' then 'Transfer' else 'Normal' end Transfer, concat(concat(concat(concat(OH.ORDER_NO,'_'),TRIM(sh.shipment_no)),'_'),'FCVColombia')Shipment,OR.SHIPNODE_KEY Local, oh.order_type Tipo, oh.entry_type Canal, oh.ORIGINAL_TOTAL_AMOUNT Monto, OH.PAYMENT_RULE_ID Tipo_Pago, ol.PRIME_LINE_NO Linea, ol.item_id sku, CAST(ol.ORDERED_QTY as int)cantidad_unidades, 
ol.LINE_TOTAL total_compra, oh.other_charges Despacho, oh.customer_emailid Email, oh.customer_first_name Nombre, oh.CUSTOMER_LAST_NAME Apellido, oh.CUSTOMER_PHONE_NO Telefono,case when oh.ENTRY_TYPE='Call Center' then oh.EXTN_UNIQUE_ID_TYPE when oh.ENTRY_TYPE='CustomerOnWeb' then oh.EXTN_DOC_ID_TYPE else null end ID , replace(p.ADDRESS_LINE1,',','-') Direccion, p.ADDRESS_LINE4 sector, p.CITY ciudad, p.LATITUDE Latitud, p.LONGITUDE Longitud,sh.ASSIGNED_TO_USER_ID,es.STATUS_NAME estado, 
TO_UTC_TIMESTAMP(OH.ORDER_DATE, 'Etc/GMT-5') fecha_venta, TO_UTC_TIMESTAMP(aud1.new_STATUS_DATE,'Etc/GMT-5') Fecha_PDA, TO_UTC_TIMESTAMP(aud2.new_STATUS_DATE,'Etc/GMT-5') Fecha_inicio_picking , case when oh.order_type='SHP' then TO_UTC_TIMESTAMP(aud3.new_STATUS_DATE,'Etc/GMT-5') when oh.order_type='PICK' then TO_UTC_TIMESTAMP(aud6.new_STATUS_DATE,'Etc/GMT-5') when oh.order_type=' ' then TO_UTC_TIMESTAMP(aud8.new_STATUS_DATE,'Etc/GMT-5') else null end Fecha_Fin_Picking ,case when oh.order_type='SHP' then TO_UTC_TIMESTAMP(aud4.new_STATUS_DATE,'Etc/GMT-5') when oh.order_type='' then TO_UTC_TIMESTAMP(aud9.new_STATUS_DATE,'Etc/GMT-5') else null end fecha_intransit, case when oh.order_type='SHP' then TO_UTC_TIMESTAMP(aud5.new_STATUS_DATE,'Etc/GMT-5') when oh.order_type='PICK' then TO_UTC_TIMESTAMP(aud7.new_STATUS_DATE,'Etc/GMT-5') when oh.order_type='' then TO_UTC_TIMESTAMP(aud10.new_STATUS_DATE,'Etc/GMT-5') else null end fecha_entrega, case when oh.order_type='SHP' then TO_UTC_TIMESTAMP(aud13.new_STATUS_DATE,'Etc/GMT-5') else null end fecha_vuelta, TO_UTC_TIMESTAMP(aud12.new_STATUS_DATE,'Etc/GMT-5') fecha_Fallido, TO_UTC_TIMESTAMP(aud11.new_STATUS_DATE,'Etc/GMT-5') fecha_Cancelacion, ol.FULFILLMENT_TYPE, case when oh.NOTIFICATION_REFERENCE='CCCancel' Then 'Cancel CC' when oh.order_type='SHP' then aud4.MODIFYUSERID when oh.order_type='PICK' then aud7.MODIFYUSERID end MODIFYUSERID, oh.CREATEUSERID CREATEUSERID FROM Yfs_Order_header OH left join yfs_order_line OL on ol.order_header_key=oh.order_header_key left join yfs_order_release OR on (OH.ORDER_Header_key = OR.ORDER_Header_key and OL.ORDER_Header_key=OR.ORDER_Header_key) left join yfs_shipment_line shl on (OR.ORDER_RELEASE_KEY=shl.ORDER_RELEASE_KEY and shl.ORDER_LINE_KEY=ol.ORDER_LINE_KEY) left join yfs_shipment sh on SH.shipment_key=SHL.shipment_key left join yfs_shipment_status_audit aud1 on (sh.shipment_key = aud1.shipment_key and aud1.new_status = '1100.70.06.10') left join yfs_shipment_status_audit aud2 on (sh.shipment_key = aud2.shipment_key and aud2.new_status = '1100.70.06.20') left join yfs_shipment_status_audit aud3 on (sh.shipment_key = aud3.shipment_key and aud3.new_status = '1100.70.06.50') left join yfs_shipment_status_audit aud4 on (sh.shipment_key = aud4.shipment_key and aud4.new_status = '1400') left join yfs_shipment_status_audit aud5 on (sh.shipment_key = aud5.shipment_key and aud5.new_status = '1600.002.01') left join yfs_shipment_status_audit aud6 on (sh.shipment_key = aud6.shipment_key and aud6.new_status = '1100.70.06.30') left join yfs_shipment_status_audit aud7 on (sh.shipment_key = aud7.shipment_key and aud7.new_status = '1400.1000') left join yfs_shipment_status_audit aud8 on (sh.shipment_key = aud8.shipment_key and aud8.new_status = '1300') left join yfs_shipment_status_audit aud9 on (sh.shipment_key = aud9.shipment_key and aud9.new_status = '1400') left join yfs_shipment_status_audit aud10 on (sh.shipment_key = aud10.shipment_key and aud10.new_status = '1500') LEFT join yfs_shipment_status_audit aud12 on (sh.shipment_key = aud12.shipment_key and aud12.new_status = '1600.002.02') LEFT join yfs_shipment_status_audit aud11 on (sh.shipment_key = aud11.shipment_key and aud11.new_status = '9000') LEFT join yfs_shipment_status_audit aud13 on (sh.shipment_key = aud13.shipment_key and aud13.new_status = '3700.6000') left join YFS_PERSON_INFO p on sh.TO_ADDRESS_KEY=p.PERSON_INFO_KEY left join yfs_order_release_status rs on (rs.ORDER_HEADER_KEY=oh.ORDER_HEADER_KEY and rs.STATUS_QUANTITY='1') left join yfs_status es on (es.STATUS=rs.STATUS and es.PROCESS_TYPE_KEY='ORDER_FULFILLMENT') where OH.ENTERPRISE_key='FCVColombia' and OH.ORDER_DATE > '2023-01-22 05:00:00' and sh.shipment_no is not null and es.status_name in ('Back Ordered From Node','Ready for Backroom pick') and oh.order_type<>'' )base group by Orden,Shipment,Local,Tipo,Canal,Monto ,Tipo_Pago, despacho, email,Nombre, Apellido, Telefono, ID, direccion,sector, ciudad,latitud,longitud,ASSIGNED_TO_USER_ID,estado,fecha_venta,Fecha_PDA,Fecha_inicio_picking, Fecha_Fin_Picking,fecha_intransit, fecha_entrega, fecha_vuelta,fecha_Fallido, fecha_Cancelacion,FULFILLMENT_TYPE,MODIFYUSERID,CREATEUSERID order by fecha_venta desc ;